<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Build Tool - Virtlet</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Build Tool";
    var mkdocs_page_input_path = "dev/build-tool.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Virtlet</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">User Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../user-guide/virtlet-on-kdc/">Installing Virtlet on kubeadm-dind-cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../../user-guide/real-cluster/">Installing Virtlet on a real cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../../user-guide/apparmor/">AppArmor profiles</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Virtlet 101</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../101/architecture/">Virtlet architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/workshop-setup/">Workshop setup</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/provision-virtlet/">Virtlet provisioning</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/creating-and-managing-pods/">Creating and managing virtual machines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/network/">Virtlet networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/volumes/">Virtual machine volumes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/cloud-init/">Cloud-Init support</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/rolling-out-updates/">Rolling out updates</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/troubleshooting/">Troubleshooting</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Reference</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../reference/vm-pod-spec/">Defining a VM Pod</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/vm-pod/">Working with VM Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/volumes/">Volumes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/images/">VM Image Handling</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/injecting-files/">Injecting Files into the VM</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/cloud-init/">Cloud-Init</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/config/">Configuration</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/networking/">Networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/diagnostics/">Diagnostics</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/resources/">Resource management</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/virtletctl/">Command Line Tool</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Development</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../architecture/">Virtlet architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../setup/">Setting up the environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../tests/">Running the tests</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Build Tool</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#buildcmdsh">build/cmd.sh</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#script-usage">Script usage</a></li>
        
            <li><a class="toctree-l4" href="#control-flags">Control flags</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../virtlet-ci/">Virtlet CI</a>
                </li>
                <li class="">
                    
    <a class="" href="../cirros/">Building a custom CirrOS image</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../vm-pod-lifecycle/">Lifecycle of a VM pod</a>
                </li>
                <li class="">
                    
    <a class="" href="../guidelines/">Guidelines</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Virtlet</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Development &raquo;</li>
        
      
    
    <li>Build Tool</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="buildcmdsh">build/cmd.sh</h1>
<p><code>build/cmd.sh</code> script helps automating usage of docker build
container using <a href="https://github.com/Mirantis/virtlet/blob/master/images/Dockerfile.build">Dockerfile.build</a>.</p>
<h2 id="script-usage">Script usage</h2>
<p>Currently the script supports the following commands:</p>
<ul>
<li><code>./build/cmd.sh build</code></li>
<li><code>./build/cmd.sh test</code></li>
<li><code>./build/cmd.sh copy</code></li>
<li><code>./build/cmd.sh copy-dind</code></li>
<li><code>./build/cmd.sh start-dind</code></li>
<li><code>./build/cmd.sh vsh</code></li>
<li><code>./build/cmd.sh stop</code></li>
<li><code>./build/cmd.sh clean</code></li>
<li><code>./build/cmd.sh update-bindata</code></li>
<li><code>./build/cmd.sh update-generated-docs</code></li>
<li><code>./build/cmd.sh gotest [TEST_ARGS...]</code></li>
<li><code>./build/cmd.sh gobuild [BUILD_ARGS...]</code></li>
<li><code>./build/cmd.sh run CMD...</code></li>
<li><code>./build/cmd.sh release TAG</code></li>
<li><code>./build/cmd.sh serve-docs</code></li>
<li><code>./build/cmd.sh build-docs</code></li>
<li><code>./build/cmd.sh sync</code></li>
</ul>
<p><code>build</code>, <code>test</code>, <code>integration</code>, <code>run</code>, <code>gobuild</code>, <code>gotest</code>, <code>copy</code>,
<code>copy-back</code> and <code>prepare-vendor</code> commands check whether the build
container image and data volumes are available before proceeding. They
build the image if necessary and create the data volumes if they don't
exist, then, on each run they copy the local sources into
<code>virtlet_src</code> data volume.</p>
<p>The build container used by <code>build/cmd.sh</code> needs to be able to access
Docker socket inside it. By default it mounts <code>/var/run/docker.sock</code>
inside the container but you can override the path by setting
<code>DOCKER_SOCKET_PATH</code> environment variable.</p>
<h3 id="build">build</h3>
<p>Performs a full build of Virtlet. Also builds
<code>mirantis/virtlet:latest</code> image.</p>
<h3 id="test">test</h3>
<p>Runs the unit tests inside a build container.</p>
<h3 id="integration">integration</h3>
<p>Runs the integration tests. KVM is disabled for these so as to make them run
inside limited CI environments that don't support kernel virtualization.
You need to invoke <code>build/cmd.sh build</code> before running this command.</p>
<h3 id="copy">copy</h3>
<p>Extracts output binaries from build container into <code>_output/</code> in the
current directory.</p>
<h3 id="copy-back">copy-back</h3>
<p>Syncs local <code>_output_</code> contents to the build container. This is used
by CI for passing build artifacts between the jobs in a workflow.</p>
<h3 id="copy-dind">copy-dind</h3>
<p>Copies the binaries into kube-node-1 of <a href="https://github.com/kubernetes-sigs/kubeadm-dind-cluster">kubeadm-dind-cluster</a> (or
kube-master if <code>VIRTLET_ON_MASTER</code> environment variable is set to a
non-empty value). You need to do <code>dind-cluster...sh up</code> to be able to
use this command.</p>
<h3 id="start-dind">start-dind</h3>
<p>Starts Virtlet on kube-node-1 of <a href="https://github.com/kubernetes-sigs/kubeadm-dind-cluster">kubeadm-dind-cluster</a> (or
kube-master if <code>VIRTLET_ON_MASTER</code> environment variable is set to a
non-empty value). You need to do <code>dind-cluster...sh up</code> and
<code>build/cmd.sh copy-dind</code> to be able to use this command.
This command copies locally-built <code>mirantis/virtlet</code> image to
the DIND node that will run Virtlet if it doesn't exist there
or if <code>FORCE_UPDATE_IMAGE</code> is set to a non-empty value.
This command requires <code>kubectl</code>.</p>
<h3 id="prepare-all-nodes">prepare-all-nodes</h3>
<p>Makes all the worker nodes in the <a href="https://github.com/kubernetes-sigs/kubeadm-dind-cluster">kubeadm-dind-cluster</a> ready for
Virtlet pod, but doesn't start Virtlet pod on them (it doesn't apply
<code>extraRuntime=virtlet</code> label). This is done automatically for the
Virtlet node during <code>start-dind</code>, but it's necessary to do so for all
the worker nodes for Virtlet e2e config test to pass.</p>
<h3 id="vsh">vsh</h3>
<p>Starts an interactive shell using build container. Useful for debugging.</p>
<h3 id="stop">stop</h3>
<p>Removes the build container.</p>
<h3 id="clean">clean</h3>
<p>Removes the build container and image along with data volumes as well as
the binaries in local <code>_output</code> directory.</p>
<h3 id="update-bindata">update-bindata</h3>
<p>Updates generated binary assets. Currently needed if you edit files
under
<a href="https://github.com/Mirantis/virtlet/tree/master/deploy/data">deploy/data</a>
directory.</p>
<h3 id="update-generated-docs">update-generated-docs</h3>
<p>Updates generated documentation (source markdown files). This
currently includes <a href="../../reference/virtletctl/">virtletctl</a>
and <a href="../../reference/config/">config</a> documentation.</p>
<h3 id="gotest">gotest</h3>
<p>Runs unit tests suite in build container - suitable for use with IDEs/editors.</p>
<h3 id="gobuild">gobuild</h3>
<p>Runs go build in the build container. This command can be used for
syntax checking in IDEs/editors. It assumes that <code>build</code> command was invoked
at least once since the last <code>clean</code>.</p>
<h3 id="run">run</h3>
<p>Runs the specified command inside the build container. This command can be
used to debug the build scripts.</p>
<h3 id="prepare-vendor">prepare-vendor</h3>
<p>Populates <code>vendor/</code> directory inside the build container. This is used
by CI.</p>
<h3 id="start-build-container">start-build-container</h3>
<p>Starts the build container. This is done automatically by other
<code>build/cmd.sh</code> commands that need the build container.</p>
<h3 id="update-bindata_1">update-bindata</h3>
<p>Updates the generated bindata. Run this command if you modify
anything under <code>deploy/data</code>.</p>
<h3 id="update-generated">update-generated</h3>
<p>Updates the generated Go files except for bindata. Run this command if
you modify Virtlet CRD structs.</p>
<h3 id="e2e">e2e</h3>
<p>Runs Virtlet e2e tests against the currently running DIND cluster.
You can also pass test options to this command:</p>
<pre><code>build/cmd.sh e2e -test.v
</code></pre>

<p>You can also pass <a href="https://onsi.github.io/ginkgo/">Ginkgo</a> options to
this command, e.g. the following command will run only the tests that
have <code>Should have default route</code> in their description:</p>
<pre><code>build/cmd.sh e2e -test.v -ginkgo.focus=&quot;Should have default route&quot;
</code></pre>

<p>This command requires <code>kubectl</code>.</p>
<p>Virtlet e2e tests can produce JUnit-style XML output if asked to do so:</p>
<pre><code>build/cmd.sh e2e -test.v -junitOutput /tmp/junit.xml
build/cmd.sh run 'cat /tmp/junit.xml' &gt;junit.xml
</code></pre>

<h3 id="serve-docs">serve-docs</h3>
<p>Starts serving the <a href="https://www.mkdocs.org/">MkDocs</a>-built
documentation on the port specified by <code>MKDOCS_SERVE_ADDRESS</code>
environment variable (default 8042). In order to update the docs from
the current Virtlet working copy, you need to run <code>build/cmd.sh sync</code>.</p>
<h3 id="build-docs">build-docs</h3>
<p>Builds the documentation using <a href="https://www.mkdocs.org/">MkDocs</a> and
puts the result into <code>docs</code> branch. The copy of MkDocs output is
stored under <code>_docs/</code> subdirectory of the working copy. The build is
done only if the docs changed since they were last build and stored
under <code>gh-docs</code> branch or if the current working copy is dirty (i.e.
has uncommitted changes).</p>
<h3 id="sync">sync</h3>
<p>Synchronizes the working copy with the build container, starting the
build container if it's not present. This command is handy with
conjunction with <code>build/cmd.sh</code>.</p>
<h2 id="control-flags">Control flags</h2>
<p>Some of the script commands also be customized by using environment variables:</p>
<ul>
<li>
<p><code>VIRTLET_SKIP_RSYNC=1</code> disables syncing of sources in the build docker container. If set, changes made to the sources
  on the host machine will not be included into the build.</p>
</li>
<li>
<p><code>VIRTLET_RSYNC_PORT=18730</code> - port to use for rsync.</p>
</li>
<li>
<p><code>VIRTLET_ON_MASTER=1</code> - start <code>virtlet</code> on the master (API) k8s node rather than on the worker.</p>
</li>
<li>
<p><code>DOCKER_SOCKET_PATH=/var/run/docker.sock</code> - docker Unix socket path to mount into the build container.</p>
</li>
<li>
<p><code>DOCKER_HOST</code> - docker server to be used in the build server (when it differs from the default Unix socket).</p>
</li>
<li>
<p><code>FORCE_UPDATE_IMAGE=1</code> - always propagate <code>virtlet</code> docker image from the host into DinD cluster (by default, it is done
  when no such image exist).</p>
</li>
<li>
<p><code>IMAGE_REGEXP_TRANSLATION=1</code> enables regexp syntax in image name translation rules.
  See <a href="../../reference/images/#image-name-translation">Image Name Translation</a> for more details.</p>
</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../virtlet-ci/" class="btn btn-neutral float-right" title="Virtlet CI">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../tests/" class="btn btn-neutral" title="Running the tests"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../tests/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../virtlet-ci/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
