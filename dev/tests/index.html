<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Running the tests - Virtlet</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Running the tests";
    var mkdocs_page_input_path = "dev/tests.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Virtlet</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">User Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../user-guide/virtlet-on-kdc/">Installing Virtlet on kubeadm-dind-cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../../user-guide/real-cluster/">Installing Virtlet on a real cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../../user-guide/apparmor/">AppArmor profiles</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Virtlet 101</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../101/architecture/">Virtlet architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/workshop-setup/">Workshop setup</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/provision-virtlet/">Virtlet provisioning</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/creating-and-managing-pods/">Creating and managing virtual machines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/network/">Virtlet networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/volumes/">Virtual machine volumes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/cloud-init/">Cloud-Init support</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/rolling-out-updates/">Rolling out updates</a>
                </li>
                <li class="">
                    
    <a class="" href="../../101/troubleshooting/">Troubleshooting</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Reference</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../reference/vm-pod-spec/">Defining a VM Pod</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/vm-pod/">Working with VM Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/volumes/">Volumes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/images/">VM Image Handling</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/injecting-files/">Injecting Files into the VM</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/cloud-init/">Cloud-Init</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/config/">Configuration</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/networking/">Networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/diagnostics/">Diagnostics</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/resources/">Resource management</a>
                </li>
                <li class="">
                    
    <a class="" href="../../reference/virtletctl/">Command Line Tool</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Development</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../architecture/">Virtlet architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../setup/">Setting up the environment</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Running the tests</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#running-unit-and-integration-tests">Running unit and integration tests</a></li>
    

    <li class="toctree-l3"><a href="#running-tests-on-mac-os-x">Running tests on Mac OS X</a></li>
    

    <li class="toctree-l3"><a href="#running-e2e-tests">Running e2e tests</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../build-tool/">Build Tool</a>
                </li>
                <li class="">
                    
    <a class="" href="../virtlet-ci/">Virtlet CI</a>
                </li>
                <li class="">
                    
    <a class="" href="../cirros/">Building a custom CirrOS image</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../vm-pod-lifecycle/">Lifecycle of a VM pod</a>
                </li>
                <li class="">
                    
    <a class="" href="../guidelines/">Guidelines</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Virtlet</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Development &raquo;</li>
        
      
    
    <li>Running the tests</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="running-unit-and-integration-tests">Running unit and integration tests</h1>
<p>In order to run unit tests, use:</p>
<pre><code>$ build/cmd.sh test
</code></pre>

<p>In order to run integration, use:</p>
<pre><code>$ build/cmd.sh integration
</code></pre>

<p>There's a number of 'golden master' tests in Virtlet. These tests work
by generating some JSON data and comparing it to the previous version
of that data stored in git index (i.e. staged or committed). The test
fails if there's any difference, and the file is updated in this case.
You need to stage or commit the changes to make the test pass (or fix
the code so there's no changes).</p>
<p>Sample usage:</p>
<pre><code>$ cd pkg/libvirttools/

$ ../../build/cmd.sh gotest
--- FAIL: TestDomainDefinitions (0.35s)
    --- FAIL: TestDomainDefinitions/cloud-init_with_user_data (0.05s)
        gm.go:58: got difference for &quot;TestDomainDefinitions/cloud-init_with_user_data&quot;:
                diff --git a/pkg/libvirttools/TestDomainDefinitions__cloud-init_with_user_data.json b/pkg/libvirttools/TestDomainDefinitions__cloud-init_with_user_data.json
                index e852f8b..6db03cc 100755
                --- a/pkg/libvirttools/TestDomainDefinitions__cloud-init_with_user_data.json
                +++ b/pkg/libvirttools/TestDomainDefinitions__cloud-init_with_user_data.json
                @@ -66,7 +66,7 @@
                     &quot;name&quot;: &quot;domain conn: iso image&quot;,
                     &quot;data&quot;: {
                       &quot;meta-data&quot;: &quot;{\&quot;instance-id\&quot;:\&quot;testName_0.default\&quot;,\&quot;local-hostname\&quot;:\&quot;testName_0\&quot;,\&quot;public-keys\&quot;:[\&quot;key1\&quot;,\&quot;key2\&quot;]}&quot;,
                -      &quot;user-data&quot;: &quot;#cloud-config\nusers:\n- name: cloudy\n&quot;
                +      &quot;user-data&quot;: &quot;#cloud-config\nusers:\n- name: cloudy1\n&quot;
                     }
                   },
                   {
FAIL
exit status 1
FAIL    github.com/Mirantis/virtlet/pkg/libvirttools    0.466s

$ # accept the changes by staging them
$ git add TestDomainDefinitions__cloud-init_with_user_data.json

$ ../../build/cmd.sh gotest
PASS
ok      github.com/Mirantis/virtlet/pkg/libvirttools    0.456s
</code></pre>

<h1 id="running-tests-on-mac-os-x">Running tests on Mac OS X</h1>
<p>To run tests on Mac OS X you need a working Go 1.8 installation and
<a href="https://glide.sh/">Glide</a>. You also need to install <code>cdrtools</code>
package and then make a symbolic link for <code>mkisofs</code> named
<code>genisoimage</code>:</p>
<pre><code>$ brew install cdrtools
$ sudo ln -s `which mkisofs` /usr/local/bin/genisoimage
</code></pre>

<p>Some of the tests such as integration/e2e and network related tests
only run on Linux. That being said, some of the tests do run on Mac OS
X. First you need to make sure Virtlet is checked out as
<code>$GOPATH/src/github.com/Mirantis/virtlet</code> and install the glide deps:</p>
<pre><code>$ cd &quot;$GOPATH/src/github.com/Mirantis/virtlet&quot;
$ glide install --strip-vendor
</code></pre>

<pre><code>$ go test -v ./pkg/{flexvolume,imagetranslation,libvirttools,metadata,stream,utils,tapmanager}
</code></pre>

<h1 id="running-e2e-tests">Running e2e tests</h1>
<p>You need a running Kubernetes cluster to run e2e tests.  Virtlet e2e
tests can be run using Virtlet build container:</p>
<pre><code>$ # run some e2e tests
$ build/cmd.sh e2e -test.v

$ # run e2e tests that have 'Should have default route' in their description
$ build/cmd.sh e2e -test.v -ginkgo.focus=&quot;Should have default route&quot;
</code></pre>

<p>You can also build the e2e runner locally and run it on either Mac or
Linux:</p>
<pre><code>$ glide i --strip-vendor
$ go test -i -c -o _output/virtlet-e2e-tests ./tests/e2e
$ _output/virtlet-e2e-tests -ginkgo.v
</code></pre>

<p>Virtlet uses <a href="https://onsi.github.io/ginkgo/">Ginkgo</a> for its e2e
tests, so you can refer to the list of
<a href="https://onsi.github.io/ginkgo/#the-ginkgo-cli">Ginkgo CLI flags</a>. The
Ginkgo flags should be passed using <code>-ginkgo.XXX</code> convention.</p>
<p>The following additional flags are recognized by Virtlet e2e runner:</p>
<ul>
<li><code>-cluster-url=URL</code> (default <code>http://127.0.0.1:8080</code>) specifies an
  insecure apiserver endpoint to use. You can use <code>kubectl proxy</code> when
  running the tests against a real cluster.</li>
<li><code>-image=LOCATION</code> (defaults to Virtlet's modified CirrOS image)
  specifies the location of the image to use for the tests. The
  <code>LOCATION</code> is an URL without the protocol prefix (<code>http(s)://</code>).</li>
<li><code>-sshuser=USER</code> specifies ssh user name that should be used with the
  image.</li>
<li><code>-include-cloud-init-tests=</code> (defaults to false) specifies that
  the cloud-init tests should included.</li>
<li><code>-memoryLimit=N</code> (defaults to 160) specifies the memory limit for
  the VM that should be used. You may need to adjust this setting
  according to the requirements of the image.</li>
<li><code>-include-unsafe-tests</code> (defaults to false) includes the tests that
  can be unsafe if they're run outside the build container.
  <strong>Use with care!</strong></li>
<li><code>-junitOutput=FILENAME</code> specifies that a JUnit XML output file
  should be produced by the runner.</li>
</ul>
<p>Tests may have several labels which are included in their names and
can be used in <code>-ginkgo.focus</code> / <code>ginkgo.skip</code> options:</p>
<ul>
<li><code>[Conformance]</code> specifies the tests that any properly configured
  Kubernetes cluster with Virtlet should pass.</li>
<li><code>[Heavy]</code> specifies the tests that shouldn't be run when KVM cannot
  be used, for example, on Virtlet public CI.</li>
<li><code>[Disruptive]</code> tests may break your cluster or cause some or all of
  the VMs to be restarted.</li>
<li><code>[MultiCNI]</code> tests should be used to examine a multi-CNI setup.</li>
<li><code>[Flaky]</code> tests contain flakes that should be fixed. This label
  basically designates a known bug in either the test or Virtlet
  itself. These tests are skipped on Virtlet public CI.</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../build-tool/" class="btn btn-neutral float-right" title="Build Tool">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../setup/" class="btn btn-neutral" title="Setting up the environment"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../setup/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../build-tool/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
